{% comment %}
  Custom Bundle Builder for Power Cookies
  
  Usage: {% render 'custom-bundle-builder', product: product %}
  
  Features:
  - Two-column grid layout (mobile and desktop)
  - Dynamic pricing from product data
  - Add button that transforms into quantity selector
  - Integration with Bundler.app for cart operations
  - Integration with Seal Subscriptions
{% endcomment %}

{% liquid
  assign bundle_product = product
  
  # Fetch products from collection (use parameter or default to 'power-cookie')
  if collection_handle == blank
    assign collection_handle = 'power-cookie'
  endif
  assign cookie_collection = collections[collection_handle]
  
  # Get unique ID for this instance
  assign unique_id = 'bundle-builder-' | append: section.id | append: '-' | append: 'now' | date: '%s'
  
  # Get bulk discount configuration with priority order:
  # 1. Parameter passed to snippet (template-level config)
  # 2. Product metafield (per-product override)
  # 3. Default value
  # Format: "minQty:discountPercent,minQty:discountPercent"
  # Example: "5:0,20:10,40:18" means 5+ = 0% off, 20+ = 10% off, 40+ = 18% off
  if bulk_discounts == blank
    assign bulk_discounts = product.metafields.custom.bulk_discounts
  endif
  if bulk_discounts == blank
    assign bulk_discounts = "5:0,20:10,40:18"
  endif
  
  # Get subscription discount from product metafields or use default (10%)
  assign default_subscription_discount = product.metafields.custom.subscription_discount | default: 10
%}

{{ 'custom-bundle-builder.css' | asset_url | stylesheet_tag }}

{%- comment -%} Pass translations to JavaScript {%- endcomment -%}
<script>
  window.bundleTranslations = window.bundleTranslations || {};
  window.bundleTranslations['{{ unique_id }}'] = {
    currentLang: '{{ localization.language.iso_code }}',
    please_select_minimum: {{ 'bundles.pricing.please_select_minimum' | t | json }},
    add_items_save: {{ 'bundles.pricing.add_items_save' | t | json }},
    add_more_save: {{ 'bundles.pricing.add_more_save' | t | json }},
    saving_max: {{ 'bundles.pricing.saving_max' | t | json }},
    save_on_delivery: {{ 'bundles.purchase_options.save_on_delivery' | t | json }},
    discount_all_orders: {{ 'bundles.purchase_options.discount_all_orders' | t | json }}
  };
</script>

{%- comment -%} Hidden Seal Subscriptions widget for selling plan data {%- endcomment -%}
{%- comment -%} Get selling plans from first cookie product in collection {%- endcomment -%}
{%- assign first_cookie_product = cookie_collection.products.first -%}
<div style="display: none;" class="sealsubs-container sealsubs-target-element" data-product-id="{{ first_cookie_product.id }}">
  {%- if first_cookie_product.selling_plan_groups.size > 0 -%}
    {%- for selling_plan_group in first_cookie_product.selling_plan_groups -%}
      {%- for selling_plan in selling_plan_group.selling_plans -%}
        {%- assign option_value = selling_plan.options.first.value -%}
        <input type="radio" 
               name="selling_plan" 
               value="{{ selling_plan.id }}"
               data-frequency="{{ option_value | split: ' ' | first }}"
               data-option1="{{ option_value }}"
               id="selling-plan-{{ selling_plan.id }}">
        <label for="selling-plan-{{ selling_plan.id }}">{{ option_value }}</label>
      {%- endfor -%}
    {%- endfor -%}
  {%- else -%}
    {%- comment -%} DEBUG: No selling plans found {%- endcomment -%}
    <div data-debug="no-selling-plans" data-product="{{ first_cookie_product.title }}"></div>
  {%- endif -%}
</div>

<div class="custom-bundle-builder" 
     id="{{ unique_id }}" 
     data-product-id="{{ bundle_product.id }}"
     data-bulk-discounts="{{ bulk_discounts }}"
     data-default-subscription-discount="{{ default_subscription_discount }}">
  
  {%- comment -%} Flavor Grid {%- endcomment -%}
  <div class="bundle-flavors-grid">
    {% if cookie_collection and cookie_collection.products.size > 0 %}
      {% for cookie_product in cookie_collection.products %}
        {% for variant in cookie_product.variants %}
          {%- comment -%} Get variant display name {%- endcomment -%}
          {% assign variant_name = variant.title %}
          {% if variant_name == "Default Title" %}
            {% assign variant_name = cookie_product.title %}
          {% endif %}
          
          <div class="flavor-card" 
               data-variant-id="{{ variant.id }}"
               data-product-id="{{ cookie_product.id }}"
               data-price="{{ variant.price | money_without_currency | replace: ',', '.' }}"
               data-flavor="{{ variant_name }}">
            
            {%- comment -%} Product/Variant Image {%- endcomment -%}
            <div class="flavor-card__image">
              {% if variant.image %}
                <img src="{{ variant.image | image_url: width: 150 }}" 
                     alt="{{ variant_name }}" 
                     loading="lazy"
                     width="150"
                     height="150">
              {% elsif cookie_product.featured_image %}
                <img src="{{ cookie_product.featured_image | image_url: width: 150 }}" 
                     alt="{{ variant_name }}" 
                     loading="lazy"
                     width="150"
                     height="150">
              {% endif %}
            </div>
            
            {%- comment -%} Flavor Info & Actions Container {%- endcomment -%}
            <div class="flavor-card__content">
              <div class="flavor-card__info">
                <h3 class="flavor-card__title">{{ variant_name }}</h3>
              </div>
              
              {%- comment -%} Add Button / Quantity Selector {%- endcomment -%}
              <div class="flavor-card__actions">
              <button type="button" class="flavor-add-btn" data-action="add" data-price="{{ variant.price | money_without_currency | replace: ',', '.' }}">
                {{ 'bundles.add_button' | t | default: 'Add' }} - €<span class="price-value">{{ variant.price | money_without_currency | replace: ',', '.' }}</span>
              </button>
              
              <div class="flavor-quantity-selector" style="display: none;">
                <button type="button" class="qty-btn qty-minus" data-action="decrease">
                  <svg width="12" height="2" viewBox="0 0 12 2" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M0 1H12" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </button>
                <input type="number" 
                       class="qty-input" 
                       value="0" 
                       min="0" 
                       max="999"
                       inputmode="numeric"
                       pattern="[0-9]*">
                <button type="button" class="qty-btn qty-plus" data-action="increase">
                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 0V12M0 6H12" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </button>
              </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% endfor %}
    {% else %}
      <p class="bundle-error">{{ 'bundles.no_products' | t | default: 'No products available' }}</p>
    {% endif %}
  </div>
  
  {%- comment -%} Subscription & Pricing Section {%- endcomment -%}
  <div class="bundle-purchase-options">
    
    {%- comment -%} Purchase Options Cards {%- endcomment -%}
    <div class="purchase-options-container">
      
      {%- comment -%} One-Time Purchase Card {%- endcomment -%}
      <div class="purchase-option-card" data-subscription-type="one-time">
        <input type="radio" 
               id="one-time-{{ unique_id }}" 
               name="subscription-{{ unique_id }}" 
               value="one-time" 
               checked>
        <label for="one-time-{{ unique_id }}">
          <div class="purchase-option-header">
            <div class="purchase-option-info">
              <div class="purchase-option-title-row">
                <span class="radio-custom"></span>
                <span class="purchase-option-title">{{ 'bundles.purchase_options.one_time' | t | default: 'One-time purchase' }}</span>
              </div>
              <span class="purchase-option-subtitle"><span class="option-cookie-count">0</span> {{ 'bundles.purchase_options.cookies' | t | default: 'cookies' }}</span>
            </div>
            <div class="purchase-option-price">
              <span class="option-price-value">€0.00</span>
            </div>
          </div>
        </label>
      </div>
      
      {%- comment -%} Subscribe & Save Card {%- endcomment -%}
      <div class="purchase-option-card" data-subscription-type="subscribe">
        <div class="purchase-option-banner">
          {{ 'bundles.purchase_options.save_on_delivery' | t | default: 'Save 10% on every delivery' }}
        </div>
        
        <input type="radio" 
               id="subscribe-{{ unique_id }}" 
               name="subscription-{{ unique_id }}" 
               value="subscribe">
        <label for="subscribe-{{ unique_id }}">
          <div class="purchase-option-header">
            <div class="purchase-option-info">
              <div class="purchase-option-title-row">
                <span class="radio-custom"></span>
                <span class="purchase-option-title">{{ 'bundles.purchase_options.subscribe_save' | t | default: 'Subscribe & Save' }}</span>
              </div>
              <span class="purchase-option-subtitle"><span class="option-cookie-count">0</span> {{ 'bundles.purchase_options.cookies' | t | default: 'cookies' }}</span>
            </div>
            <div class="purchase-option-price">
              <span class="option-price-original">€0.00</span>
              <span class="option-price-value">€0.00</span>
            </div>
          </div>
        </label>
        
        {%- comment -%} How Subscription Works {%- endcomment -%}
        <div class="subscription-info-box">
          <h4 class="subscription-info-title">{{ 'bundles.purchase_options.how_subscription_works' | t | default: 'How subscription works:' }}</h4>
          <ul class="subscription-info-list">
            <li><span class="info-icon">🍪</span> {{ 'bundles.purchase_options.best_price_option' | t | default: 'Best price option' }}</li>
            <li><span class="info-icon">📦</span> <span class="subscription-discount-text">{{ 'bundles.purchase_options.discount_all_orders' | t | default: '10% off all recurring orders' }}</span></li>
            <li><span class="info-icon">✏️</span> {{ 'bundles.purchase_options.easily_modify' | t | default: 'Easily modify order' }}</li>
            <li><span class="info-icon">❌</span> {{ 'bundles.purchase_options.easily_cancel' | t | default: 'Easily cancel anytime' }}</li>
          </ul>
        </div>
        
        {%- comment -%} Delivery Frequency Selector (shows when subscription is selected) {%- endcomment -%}
        <div class="delivery-frequency-selector" style="display: none;">
          <label for="delivery-frequency-{{ unique_id }}" class="delivery-frequency-label">
            {{ 'bundles.purchase_options.delivers_every' | t | default: 'Delivers every' }}
          </label>
          <select id="delivery-frequency-{{ unique_id }}" class="delivery-frequency-select">
            {%- comment -%} Options will be populated dynamically from Seal Subscriptions {%- endcomment -%}
          </select>
        </div>
      </div>
      
    </div>
    
    {%- comment -%} Bulk Discount Help Text {%- endcomment -%}
    <div class="bundle-discount-progress">
      <span class="pricing-help-text">{{ 'bundles.select_cookies' | t | default: 'Select cookies to see savings' }}</span>
    </div>
    
    {%- comment -%} Add to Cart Button {%- endcomment -%}
    <button type="button" class="bundle-add-to-cart" disabled>
      {{ 'bundles.purchase_options.add_to_cart' | t | default: 'Add to cart' }}
    </button>
    
    {%- comment -%} Error Messages {%- endcomment -%}
    <div class="bundle-error-message" style="display: none;"></div>
  </div>
  
  {%- comment -%} Hidden data for Bundler integration {%- endcomment -%}
  <div class="bundle-data" style="display: none;">
    <input type="hidden" class="bundle-shortcode" value="eap6">
    <input type="hidden" class="bundle-selections" value="{}">
  </div>
</div>

<script src="{{ 'custom-bundle-builder.js' | asset_url }}" defer></script>

<script>
  // Initialize bundle builder when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      if (window.CustomBundleBuilder) {
        window.CustomBundleBuilder.init('{{ unique_id }}');
      }
    });
  } else {
    if (window.CustomBundleBuilder) {
      window.CustomBundleBuilder.init('{{ unique_id }}');
    }
  }
</script>

